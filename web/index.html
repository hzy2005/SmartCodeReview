<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Smart Code Review Assistant</title>
    <style>
      :root{
        --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
        --primary:#6366f1; --primary-600:#5458ee; --success:#10b981; --warn:#f59e0b; --danger:#ef4444;
        --shadow:0 8px 24px rgba(0,0,0,.08); --radius:14px;
      }
      @media (prefers-color-scheme: dark){
        :root{
          --bg:#0b0e14; --card:#0f1420; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937;
          --primary:#7c7eff; --primary-600:#6c6eff; --shadow:0 10px 28px rgba(0,0,0,.35);
        }
      }
      *{box-sizing:border-box} html,body{height:100%}
      body{margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; line-height:1.5;}
      .container{max-width:1100px; margin:32px auto; padding:0 16px}
      .header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
      .title{display:flex; align-items:center; gap:12px; font-weight:700; font-size:22px}
      .logo{width:36px; height:36px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,var(--primary), #22d3ee); color:#fff; font-weight:800; box-shadow:var(--shadow);}
      .hint{color:var(--muted); font-size:13px}

      .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
      .controls{padding:16px; display:grid; grid-template-columns:1fr; gap:12px}
      @media (min-width: 850px){ .controls{grid-template-columns: 1.2fr 2.2fr auto} }
      .field{display:flex; align-items:center; gap:10px}
      select, input[type="text"]{background:transparent; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:none; width:100%;}
      .switch{display:inline-flex; align-items:center; gap:10px; user-select:none; color:var(--muted)}
      .switch input{display:none}
      .toggle{width:46px; height:26px; border-radius:999px; background:#c7c9ff33; position:relative; transition:.2s; border:1px solid var(--border);}
      .toggle::after{content:""; position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.2); transition:.2s;}
      .switch input:checked + .toggle{ background:var(--primary) }
      .switch input:checked + .toggle::after{ transform:translateX(20px) }
      .btn{border:none; background:var(--primary); color:#fff; font-weight:700; padding:12px 16px; border-radius:12px; cursor:pointer; box-shadow:var(--shadow); transition:transform .05s ease, background .15s ease; white-space:nowrap;}
      .btn:hover{ background:var(--primary-600) } .btn:active{ transform:translateY(1px) } .btn[disabled]{ opacity:.6; cursor:not-allowed }
      .subrow{display:flex; gap:8px; flex-wrap:wrap; padding:0 16px 16px}
      .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px dashed var(--border); color:var(--muted); font-size:12px;}
      .pill button{border:none; background:transparent; color:var(--primary); cursor:pointer; font-weight:700}

      .editor{margin-top:14px; padding:12px}
      textarea{width:100%; min-height:260px; resize:vertical; border:1px solid var(--border); border-radius:12px; padding:12px 14px; background:var(--card); color:var(--text); font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;}

      .grid{margin-top:16px; display:grid; gap:14px; grid-template-columns: 1fr}
      @media (min-width: 1000px){ .grid{ grid-template-columns: 1.1fr 1.1fr 1.1fr } }
      .section{padding:14px} .section h2{display:flex; align-items:center; justify-content:space-between; margin:0 0 8px}
      .count{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(0,0,0,.02));}
      ul{margin:0; padding-left:16px} li{margin:6px 0}
      .sev{display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; margin-right:6px; color:#fff}
      .sev.high{background:var(--danger)} .sev.medium{background:var(--warn)} .sev.low{background:var(--success)}
      pre{background:rgba(127,127,127,.08); padding:10px; border-radius:10px; overflow:auto; border:1px solid var(--border)}

      .suggest{margin-top:14px; padding:14px}
      .suggest .bar{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
      .ghost{opacity:.7}
      #sugg-md h1,#sugg-md h2,#sugg-md h3{margin:10px 0 8px}
      #sugg-md code{background:rgba(127,127,127,.12); padding:2px 6px; border-radius:6px; font-family: ui-monospace,Consolas,Menlo,monospace}
      #sugg-md pre{background:rgba(127,127,127,.08); border:1px solid var(--border); padding:12px; border-radius:12px; overflow:auto}
      #sugg-md pre code{background:transparent; padding:0}
      #sugg-md ul{padding-left:20px; margin:6px 0}
      #sugg-md li{margin:4px 0}

      .status{position:fixed; top:16px; right:16px; background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:10px 12px; display:flex; align-items:center; gap:8px; z-index:1000; min-width:220px;}
      .spinner{width:18px; height:18px; border-radius:50%; border:2px solid #d1d5db; border-top-color:var(--primary); animation:spin .8s linear infinite}
      @keyframes spin{to{transform:rotate(360deg)}} .hidden{display:none}
      .badge{font-size:11px; padding:3px 6px; border-radius:8px; border:1px solid var(--border); color:var(--muted)}
      .copy-btn{background:transparent; border:1px solid var(--border); color:var(--muted); border-radius:10px; padding:6px 10px; cursor:pointer}
      .copy-btn:hover{ color:var(--text) }
      .endpoint{min-width:240px;}
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="title"><div class="logo">AI</div>Smart Code Review Assistant</div>
        <div class="hint">粘贴代码 → Analyze → 获取问题与建议</div>
      </div>

      <div class="card">
        <div class="controls">
          <div class="field">
            <label for="lang" class="badge">Language</label>
            <select id="lang" aria-label="Language">
              <option value="python">Python</option>
              <option value="java">Java</option>
            </select>
          </div>

          <div class="field">
            <label for="endpoint" class="badge">API Endpoint</label>
            <input id="endpoint" class="endpoint" type="text" placeholder="http://localhost:8000/analyze" value="http://localhost:8000/analyze" />
          </div>

          <div class="field" style="justify-content:flex-end;">
            <label class="switch" title="Enable/Disable LLM">
              <input type="checkbox" id="llm" checked />
              <span class="toggle" aria-hidden="true"></span>
              <span>Enable LLM</span>
            </label>
            <button id="run" class="btn" title="Analyze the pasted code">Analyze</button>
          </div>
        </div>

        <div class="subrow">
          <div class="pill">需要示例？<button id="fill-python">Python</button> · <button id="fill-java">Java</button></div>
          <div class="pill">提示：代码很大时可分模块分析，提高速度。</div>
        </div>

        <div class="editor">
          <textarea id="code" placeholder="Paste your Python/Java code here..."></textarea>
        </div>
      </div>

      <div class="grid">
        <div class="card section" id="sec-issues">
          <h2>Potential Bugs <span id="cnt-issues" class="count">0</span></h2>
          <ul id="list-issues"></ul>
        </div>
        <div class="card section" id="sec-smells">
          <h2>Code Smells <span id="cnt-smells" class="count">0</span></h2>
          <ul id="list-smells"></ul>
        </div>
        <div class="card section" id="sec-security">
          <h2>Security Issues <span id="cnt-security" class="count">0</span></h2>
          <ul id="list-security"></ul>
        </div>
      </div>

      <div class="card suggest" id="suggest">
        <div class="bar">
          <h2>Suggestions</h2>
          <div style="display:flex; gap:8px; align-items:center">
            <span id="llm-status" class="badge">LLM: auto</span>
            <button id="copy-sugg" class="copy-btn" title="Copy suggestions">Copy</button>
          </div>
        </div>
        <div id="sugg-md" style="margin:0"></div>
      </div>
    </div>

    <div id="status" class="status hidden" aria-live="polite">
      <div class="spinner"></div>
      <div id="status-text">Analyzing…</div>
    </div>

    <script>
      const $ = (sel)=>document.querySelector(sel);
      const byId = (id)=>document.getElementById(id);
      // const escapeHtml = (s)=> (s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

      function setLoading(on, text="Analyzing…"){
        const bar = byId('status');
        byId('status-text').textContent = text;
        bar.classList.toggle('hidden', !on);
        byId('run').disabled = on;
      }
      let toastTimer=null;
      function toasty(msg){
        const bar = byId('status');
        byId('status-text').textContent = msg;
        bar.classList.remove('hidden');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(()=> bar.classList.add('hidden'), 1200);
      }
      const severityClass = (sev)=> (sev||'').toLowerCase();

      function extractJsonFromText(text) {
        if (typeof text !== 'string') return null;
        
        // 移除可能的代码块标记
        let cleaned = text.replace(/```json\s*/gi, '').replace(/```\s*$/gi, '');
        
        // 尝试直接解析
        try {
          return JSON.parse(cleaned);
        } catch (e1) {
          // 如果失败，尝试提取最外层的大括号内容
          const start = cleaned.indexOf('{');
          const end = cleaned.lastIndexOf('}');
          
          if (start !== -1 && end !== -1 && end > start) {
            try {
              const jsonStr = cleaned.substring(start, end + 1);
              // 修复常见的JSON格式问题
              const fixedJson = jsonStr
                .replace(/,(\s*[}\]])/g, '$1') // 移除尾随逗号
                .replace(/(\w+):/g, '"$1":')   // 为未加引号的key添加引号
                .replace(/:\s*'([^']*)'/g, ': "$1"'); // 单引号转双引号
              
              return JSON.parse(fixedJson);
            } catch (e2) {
              console.log("JSON解析失败:", e2);
              return null;
            }
          }
        }
        
        return null;
      }

      // === 关键新增：从“残缺 JSON 文本”里稳健提取指定字段的“字符串值” ===
      function tryExtractJsonStringField(text, fieldName){
        if (typeof text !== 'string') return null;
        const idx = text.indexOf(`"${fieldName}"`);
        if (idx < 0) return null;
        // 在 idx 之后寻找第一个冒号
        const colon = text.indexOf(':', idx);
        if (colon < 0) return null;
        // 跳过空白，必须是引号开头
        let i = colon + 1;
        while (i < text.length && /\s/.test(text[i])) i++;
        if (text[i] !== '"') return null;
        i++; // 跳过开引号

        // 扫描字符串（处理 \\"、\\n 等转义），直到遇到未转义的引号或文本结束
        let buf = '';
        let esc = false;
        for (; i < text.length; i++){
          const ch = text[i];
          if (esc){ buf += ch; esc = false; continue; }
          if (ch === '\\'){ esc = true; continue; }
          if (ch === '"'){ break; }
          buf += ch;
        }
        // 尝试用 JSON 字符串语义还原转义
        try { return JSON.parse('"' + buf + '"'); } catch { return buf.replace(/\\n/g, '\n').replace(/\\"/g, '"'); }
      }

      // === 关键新增：从“残缺 JSON 文本”里尽量抠出数组里的关键信息 ===
      function salvageArrayFromJsonLike(text, fieldName){
        if (typeof text !== 'string') return [];
        const keyIndex = text.indexOf(`"${fieldName}"`);
        if (keyIndex < 0) return [];
        const arrStart = text.indexOf('[', keyIndex);
        if (arrStart < 0) return [];
        // 粗略截取到下一个 ']' 或文本末尾
        const arrEnd = text.indexOf(']', arrStart);
        const segment = text.slice(arrStart + 1, arrEnd >= 0 ? arrEnd : text.length);

        // 分割成可能的对象片段（按 "}," 或 "}\n" 粗分）
        const parts = segment.split(/}\s*,?\s*{|\n}\s*\n/g).map((p, idx, all)=>{
          // 还原成完整对象文本
          const left = idx === 0 ? '{' + p : '{' + p;
          const right = (idx === all.length - 1) ? '}' : '}';
          return left + right;
        });

        const out = [];
        for (const p of parts){
          // 删除尾逗号
          const cleaned = p.replace(/,\s*([}\]])/g, '$1');
          try{
            const obj = JSON.parse(cleaned);
            out.push({
              rule_id: obj.rule_id,
              severity: obj.severity,
              message: obj.message,
              start_line: obj.start_line,
              end_line: obj.end_line,
              snippet: obj.snippet
            });
          }catch{
            // 再粗提取（regex）
            const get = (k)=> {
              const m = cleaned.match(new RegExp(`"${k}"\\s*:\\s*"(.*?)"`, 's'));
              return m ? m[1].replace(/\\n/g,'\n').replace(/\\"/g,'"') : undefined;
            }
            const getNum = (k)=> {
              const m = cleaned.match(new RegExp(`"${k}"\\s*:\\s*(\\d+)`));
              return m ? parseInt(m[1]) : undefined;
            }
            const obj2 = {
              rule_id: get('rule_id'),
              severity: get('severity'),
              message: get('message'),
              start_line: getNum('start_line'),
              end_line: getNum('end_line'),
              snippet: get('snippet')
            };
            if (obj2.rule_id || obj2.message || obj2.snippet) out.push(obj2);
          }
        }
        return out;
      }

      // function normalizeMd(s) {
      //   if (!s) return '';
      //   let t = String(s).replace(/\r\n/g, '\n');
        
      //   // 首先处理转义字符
      //   t = t.replace(/\\\\n/g, '\n')
      //       .replace(/\\\\t/g, '\t')
      //       .replace(/\\\\"/g, '"')
      //       .replace(/\\\\'/g, "'")
      //       .replace(/\\\\\\\\/g, '\\');

      //   // 修复错误的代码块格式：```\n``` → 移除空的代码块
      //   t = t.replace(/```\s*\n\s*```/g, '');
        
      //   // 修复不完整的代码块开始标记
      //   t = t.replace(/(##\s*\d+\.\s*[^\n]+)\s*```\s*\n\s*```/g, '$1\n\n*代码示例缺失*');
        
      //   // 统一围栏格式
      //   t = t.replace(/^\s*`{3,}(\w+)?\s*$/gm, (_, lang) => '```' + (lang || ''));
      //   t = t.replace(/^\s*`{3,}\s*$/gm, '```');
        
      //   // 修复不完整的代码块标记
      //   t = t.replace(/(^|\n)\s*`{0,2}(python|json|javascript)?`{0,2}\s*(?=\n|$)/gi, '\n```$2\n');
        
      //   // 自动补齐闭合围栏
      //   const lines = t.split('\n');
      //   let out = [], inFence = false, currentFence = '';
        
      //   for (let i = 0; i < lines.length; i++) {
      //     const rawLine = lines[i];
      //     const line = rawLine.trim();
          
      //     if (inFence) {
      //       // 在代码块中，检查是否遇到结束标记
      //       if (line.startsWith('```')) {
      //         out.push('```');
      //         inFence = false;
      //         continue;
      //       }
      //       out.push(rawLine);
      //       // 如果是最后一行还在代码块中，自动闭合
      //       if (i === lines.length - 1) {
      //         out.push('```');
      //         inFence = false;
      //       }
      //     } else {
      //       // 不在代码块中，检查是否遇到开始标记
      //       const fenceMatch = rawLine.match(/^```(\w*)\s*$/);
      //       if (fenceMatch) {
      //         out.push('```' + fenceMatch[1]);
      //         inFence = true;
      //         currentFence = fenceMatch[1];
      //       } else {
      //         // 检查是否应该开始代码块（基于内容判断）
      //         const nextLine = i < lines.length - 1 ? lines[i + 1] : '';
      //         const looksLikeCodeStart = /^(修复前|修复后|#\s*修复|```)/.test(rawLine) || 
      //                                 (/^```/.test(nextLine) && /[{}();=]/.test(rawLine));
              
      //         if (looksLikeCodeStart && !inFence) {
      //           out.push('```');
      //           out.push(rawLine);
      //           inFence = true;
      //         } else {
      //           out.push(rawLine);
      //         }
      //       }
      //     }
      //   }
        
      //   t = out.join('\n');
        
      //   // 最后再次清理空的代码块
      //   t = t.replace(/```\s*\n\s*```/g, '');
        
      //   return t;
      // }

      function normalizeMd(s) {
        if (!s) return '';
        
        // 基本清理
        let t = String(s)
          .replace(/\r\n/g, '\n')
          .replace(/\\\\n/g, '\n')
          .replace(/\\\\t/g, '\t')
          .replace(/\\\\"/g, '"')
          .replace(/\\\\'/g, "'")
          .replace(/\\\\\\\\/g, '\\')
          .replace(/\\n/g, '\n')
          .replace(/\\t/g, '\t')
          .replace(/\\"/g, '"')
          .replace(/\\'/g, "'");
        
        // 确保代码块格式正确
        const lines = t.split('\n');
        let result = [];
        let inCodeBlock = false;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          if (line.trim().startsWith('```')) {
            if (!inCodeBlock) {
              // 开始代码块
              result.push(line.trim());
              inCodeBlock = true;
            } else {
              // 结束代码块
              result.push('```');
              inCodeBlock = false;
            }
          } else if (inCodeBlock) {
            // 在代码块中，保留原样
            result.push(line);
          } else {
            // 不在代码块中，简单清理
            result.push(line.trim());
          }
        }
        
        // 如果最后还在代码块中，添加结束标记
        if (inCodeBlock) {
          result.push('```');
        }
        
        return result.join('\n');
      }


      function md(markdown) {
        if (!markdown) return '';
        
        const lines = markdown.split('\n');
        let output = [];
        let inCodeBlock = false;
        let codeBlockContent = [];
        let currentLanguage = '';
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // 检查是否是代码块开始
          if (line.trim().startsWith('```')) {
            if (!inCodeBlock) {
              // 开始代码块
              inCodeBlock = true;
              currentLanguage = line.trim().replace(/```/, '').trim();
              // 如果有之前的文本内容，先处理
              if (output.length > 0 && !output[output.length - 1].endsWith('</ul>')) {
                // 确保最后一个是段落
                const lastLine = output[output.length - 1];
                if (!lastLine.startsWith('<') || lastLine.startsWith('<p>')) {
                  output[output.length - 1] = wrapParagraph(lastLine);
                }
              }
            } else {
              // 结束代码块
              inCodeBlock = false;
              if (codeBlockContent.length > 0) {
                const codeHtml = `<pre><code class="language-${currentLanguage}">${escapeHtml(codeBlockContent.join('\n'))}</code></pre>`;
                output.push(codeHtml);
                codeBlockContent = [];
              }
              currentLanguage = '';
            }
            continue;
          }
          
          if (inCodeBlock) {
            // 在代码块中，直接收集内容
            codeBlockContent.push(line);
          } else {
            // 不在代码块中，处理Markdown
            const trimmed = line.trim();
            
            if (!trimmed) {
              // 空行
              if (output.length > 0 && !output[output.length - 1].endsWith('</ul>')) {
                const lastLine = output[output.length - 1];
                if (!lastLine.startsWith('<') || lastLine.startsWith('<p>')) {
                  output[output.length - 1] = wrapParagraph(lastLine);
                }
              }
              continue;
            }
            
            // 处理标题
            if (trimmed.startsWith('### ')) {
              output.push(`<h3>${escapeHtml(trimmed.substring(4))}</h3>`);
            } else if (trimmed.startsWith('## ')) {
              output.push(`<h2>${escapeHtml(trimmed.substring(3))}</h2>`);
            } else if (trimmed.startsWith('# ')) {
              output.push(`<h1>${escapeHtml(trimmed.substring(2))}</h1>`);
            } 
            // 处理列表项
            else if (trimmed.match(/^[-*]\s+/)) {
              const listItem = trimmed.replace(/^[-*]\s+/, '');
              output.push(`<li>${processInlineMarkdown(listItem)}</li>`);
            }
            // 处理普通文本
            else {
              output.push(processInlineMarkdown(trimmed));
            }
          }
        }
        
        // 处理未结束的代码块
        if (inCodeBlock && codeBlockContent.length > 0) {
          const codeHtml = `<pre><code class="language-${currentLanguage}">${escapeHtml(codeBlockContent.join('\n'))}</code></pre>`;
          output.push(codeHtml);
        }
        
        // 包装连续的列表项
        output = wrapListItems(output);
        
        // 确保所有文本都在段落中
        output = output.map(line => {
          if (!line.startsWith('<') || 
              line.startsWith('<p>') || 
              line.startsWith('<h') || 
              line.startsWith('<pre') || 
              line.startsWith('<ul') || 
              line.startsWith('<li')) {
            return line;
          }
          return wrapParagraph(line);
        });
        
        return output.join('\n');
      }

      // 辅助函数：包装段落
      function wrapParagraph(text) {
        if (text.startsWith('<') && !text.startsWith('<p>')) {
          return text;
        }
        if (text.startsWith('<p>')) {
          return text;
        }
        return `<p>${text}</p>`;
      }

      // 辅助函数：处理内联Markdown（粗体、代码等）
      function processInlineMarkdown(text) {
        // 处理粗体 **text**
        text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        
        // 处理内联代码 `code`
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        return text;
      }

      // 辅助函数：包装连续的列表项
      function wrapListItems(lines) {
        const result = [];
        let inList = false;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          if (line.startsWith('<li>')) {
            if (!inList) {
              result.push('<ul>');
              inList = true;
            }
            result.push(line);
          } else {
            if (inList) {
              result.push('</ul>');
              inList = false;
            }
            result.push(line);
          }
        }
        
        // 关闭最后一个列表
        if (inList) {
          result.push('</ul>');
        }
        
        return result;
      }

      // 辅助函数：HTML转义
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function renderList(rootId, countId, arr){
        const root = byId(rootId); root.innerHTML = '';
        (arr || []).forEach(x=>{
          const li = document.createElement('li');
          const sev = document.createElement('span');
          sev.className = `sev ${severityClass(x.severity)}`;
          sev.textContent = (x.severity||'').toUpperCase();
          li.appendChild(sev);

          const strong = document.createElement('b');
          strong.textContent = ` ${x.rule_id||''} `;
          li.appendChild(strong);

          const span = document.createElement('span');
          span.innerHTML = ` - ${escapeHtml(x.message||'')}` + (x.start_line? ` <i>(L${x.start_line}${x.end_line?'-L'+x.end_line:''})</i>`:'');
          li.appendChild(span);

          if(x.snippet){ const pre = document.createElement('pre'); pre.textContent = x.snippet; li.appendChild(pre); }
          root.appendChild(li);
        });
        byId(countId).textContent = (arr||[]).length;
      }

      function mergeFromJsonIfNeeded(d0) {
        // 如果已经是对象，直接使用
        if (typeof d0 === 'object' && d0 !== null) {
          d = d0;
        } else if (typeof d0 === 'string') {
          // 尝试解析为JSON
          try {
            d = JSON.parse(d0);
          } catch {
            // 如果解析失败，当作纯文本处理
            d = {
              issues: [],
              smells: [], 
              security: [],
              suggestions_markdown: d0
            };
          }
        } else {
          d = { issues: [], smells: [], security: [], suggestions_markdown: '' };
        }

        const dedup = (arr = []) => {
          const seen = new Set();
          return arr.filter(x => {
            const k = [x.rule_id, x.message, x.start_line, x.end_line].join('|');
            if (seen.has(k)) return false;
            seen.add(k);
            return true;
          });
        };

        let sugg = String(d?.suggestions_markdown || '').trim();
        
        // 深度修复：处理多层转义和嵌套JSON
        sugg = deepUnescapeAndFix(sugg);
        
        // 尝试从suggestions_markdown中提取内层JSON
        let innerData = null;
        
        // 方法1：提取 ```json 块
        const jsonBlockMatch = sugg.match(/```json\s*([\s\S]*?)```/i);
        if (jsonBlockMatch) {
          try {
            innerData = extractJsonFromText(jsonBlockMatch[1]);
          } catch (e) {
            console.log('JSON block parse failed:', e);
          }
        }
        
        // 方法2：直接提取整个文本中的JSON
        if (!innerData) {
          try {
            innerData = extractJsonFromText(sugg);
          } catch (e) {
            // 忽略错误，继续处理
          }
        }
        
        // 方法3：容错提取（处理不完整的JSON）
        if (!innerData) {
          innerData = salvageJsonFromBrokenText(sugg);
        }

        // 合并数据
        if (innerData) {
          d.issues = dedup([...(d.issues || []), ...(innerData.issues || [])]);
          d.smells = dedup([...(d.smells || []), ...(innerData.smells || [])]);
          d.security = dedup([...(d.security || []), ...(innerData.security || [])]);
          
          // 优先使用内层的suggestions_markdown
          if (innerData.suggestions_markdown) {
            sugg = innerData.suggestions_markdown;
          }
        }

        d.suggestions_markdown = normalizeMd(sugg || '-');
        return d;
      }

      // 新增：深度反转义和修复
      function deepUnescapeAndFix(text) {
        if (typeof text !== 'string') return text;
        
        let result = text;
        
        // 多层反转义
        result = result
          .replace(/\\\\n/g, '\n')
          .replace(/\\\\t/g, '\t')
          .replace(/\\\\r/g, '\r')
          .replace(/\\\\"/g, '"')
          .replace(/\\\\'/g, "'")
          .replace(/\\\\\\\\/g, '\\');
        
        // 修复常见的格式问题
        result = result
          .replace(/\\n/g, '\n')
          .replace(/\\t/g, '\t')
          .replace(/\\"/g, '"')
          .replace(/\\'/g, "'");
        
        // 修复Markdown标题和代码块
        result = result
          .replace(/#\s*安全修复建议\s*\\n\\n/g, '# 安全修复建议\n\n')
          .replace(/\\n##\s*/g, '\n## ')
          .replace(/\\n###\s*/g, '\n### ')
          .replace(/\\n```/g, '\n```')
          .replace(/```\\n/g, '```\n');
        
        return result;
      }

      // 新增：从不完整文本中抢救JSON数据
      function salvageJsonFromBrokenText(text) {
        const result = {
          issues: [],
          smells: [],
          security: [],
          suggestions_markdown: ''
        };
        
        // 尝试提取各个数组字段
        ['issues', 'smells', 'security'].forEach(field => {
          const fieldMatch = text.match(new RegExp(`"${field}"\\s*:\\s*\\[([\\s\\S]*?)\\]`, 'i'));
          if (fieldMatch) {
            const arrayContent = fieldMatch[1];
            // 简单提取对象：查找 { ... } 模式
            const objectMatches = arrayContent.match(/\{[^}]*\}/g) || [];
            objectMatches.forEach(objStr => {
              try {
                // 修复常见的JSON问题
                const fixedObjStr = objStr
                  .replace(/,(\s*[}\]])/g, '$1') // 删除尾随逗号
                  .replace(/(\w+):/g, '"$1":')  // 为属性名添加引号
                  .replace(/:\s*'([^']*)'/g, ': "$1"'); // 单引号转双引号
                  
                const obj = JSON.parse(fixedObjStr);
                if (obj.rule_id || obj.message) {
                  result[field].push(obj);
                }
              } catch (e) {
                // 忽略解析错误
              }
            });
          }
        });
        
        // 提取suggestions_markdown
        const suggMatch = text.match(/"suggestions_markdown"\s*:\s*"([\s\S]*?)"(?=,|\s*})/);
        if (suggMatch) {
          result.suggestions_markdown = deepUnescapeAndFix(suggMatch[1]);
        }
        
        return result;
      }
      
      function renderAll(d0) {
        console.log("原始数据:", d0); // 调试用
        
        // 如果已经是对象，直接使用；如果是字符串，尝试解析
        let d = typeof d0 === 'string' ? extractJsonFromText(d0) : d0;
        
        if (!d || typeof d !== 'object') {
          d = { issues: [], smells: [], security: [], suggestions_markdown: String(d0 || '') };
        }
        // 检查是否被截断
        if (d.meta && d.meta.truncated) {
          suggestionsText += '\n\n---\n**注意**: 响应可能被截断，建议减少代码长度或分模块分析。';
        }

        // 确保必要字段存在
        d.issues = d.issues || [];
        d.smells = d.smells || [];
        d.security = d.security || [];
        d.suggestions_markdown = d.suggestions_markdown || '';

        // 渲染问题列表
        renderList('list-issues', 'cnt-issues', d.issues);
        renderList('list-smells', 'cnt-smells', d.smells);
        renderList('list-security', 'cnt-security', d.security);

        // 关键修复：只渲染 suggestions_markdown 字段
        let suggestionsText = d.suggestions_markdown;
        
        // 如果 suggestions_markdown 包含嵌套JSON，尝试提取
        if (typeof suggestionsText === 'string' && suggestionsText.includes('"suggestions_markdown"')) {
          try {
            const innerJson = extractJsonFromText(suggestionsText);
            if (innerJson && innerJson.suggestions_markdown) {
              suggestionsText = innerJson.suggestions_markdown;
            }
          } catch (e) {
            console.log("提取嵌套JSON失败:", e);
          }
        }

        // 深度清理和修复Markdown
        suggestionsText = deepUnescapeAndFix(suggestionsText);
        suggestionsText = normalizeMd(suggestionsText);
        
        console.log("最终渲染的Markdown:", suggestionsText); // 调试用
        
        // 渲染到页面
        byId('sugg-md').innerHTML = md(suggestionsText);
        byId('llm-status').textContent = `LLM: ${d?.meta?.llm ? 'on' : 'off'}`;
      }


      async function callAnalyze(){
        const code = byId('code').value;
        const language = byId('lang').value;
        const enable_llm = byId('llm').checked;
        const endpoint = byId('endpoint').value.trim() || 'http://localhost:8000/analyze';

        setLoading(true, 'Analyzing…');
        try{
          const res = await fetch(endpoint, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({language, code, enable_llm})
          });
          const txt = await res.text();  // 保持 text，兼容后端返回字符串
          let data;
          try{ data = JSON.parse(txt); }catch{ data = txt; }
          renderAll(data);
          toasty('Analysis complete.');
        }catch(e){
          console.error(e);
          renderAll({issues:[], smells:[], security:[], suggestions_markdown: String(e), meta:{llm:false}});
          toasty('Request failed.');
        }finally{
          setLoading(false);
        }
      }

      const PY_DEMO = `import os, random, sqlite3

def vulnerable_function(user_input):
    f = open("data.txt", "w")
    f.write("hello world")
    os.system("ping " + user_input)              # 命令注入
    conn = sqlite3.connect(":memory:")
    cur = conn.cursor()
    sql = "SELECT * FROM users WHERE name = '" + user_input + "'"  # SQL 注入
    cur.execute(sql)
    print(random.randint(1000,9999))             # 弱随机
    return "done"`;

      const JAVA_DEMO = `import java.io.*; import java.sql.*;
public class Demo {
  void run(Connection conn, String name) throws Exception {
    FileInputStream fis = new FileInputStream("a.txt");  // 未使用 try-with-resources
    Statement st = conn.createStatement();
    String sql = "SELECT * FROM users WHERE name = '" + name + "'";  // SQL 拼接
    st.execute(sql);
  }
}`;

      byId('run').addEventListener('click', ()=>{ callAnalyze(); });
      byId('copy-sugg').addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText((byId('sugg-md').innerText||'').trim());
          toasty('Copied suggestions.');
        }catch{ toasty('Copy failed.'); }
      });
      byId('fill-python').addEventListener('click', ()=> { byId('lang').value='python'; byId('code').value = PY_DEMO; });
      byId('fill-java').addEventListener('click', ()=> { byId('lang').value='java'; byId('code').value = JAVA_DEMO; });
      byId('code').placeholder = 'Paste your Python/Java code here...';
    </script>
  </body>
</html>
